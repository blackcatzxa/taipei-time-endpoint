name: Update Taipei Time JSON

on:
  schedule:
    - cron: "*5 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Generate now.json
        run: |
          node -e '
          const fs = require("fs");
          const nowUtc = new Date();
          const pad = n=>String(n).padStart(2,"0");
          const tzOffset = "+08:00";
          const y = nowUtc.getUTCFullYear();
          const m = pad(nowUtc.getUTCMonth()+1);
          const d = pad(nowUtc.getUTCDate());
          const hh = pad((nowUtc.getUTCHours()+8)%24);
          const mm = pad(nowUtc.getUTCMinutes());
          const ss = pad(nowUtc.getUTCSeconds());
          const taipeiIso = `${y}-${m}-${d}T${hh}:${mm}:${ss}${tzOffset}`;
          const payload = {
            source: "GitHub Actions (cron)",
            timezone: "Asia/Taipei",
            taipei_iso: taipeiIso,
            unix: Math.floor(nowUtc.getTime()/1000),
            generated_utc: nowUtc.toISOString(),
            generated_taipei: taipeiIso,
            version: "1.0.0"
          };
          fs.writeFileSync("now.json", JSON.stringify(payload,null,2));
          console.log(payload);
          '
      - name: Commit & Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add now.json
          git commit -m "auto: update now.json" || echo "No changes"
          git push
